# syntax=docker/dockerfile:1
FROM rocker/r-ver:4.5.2

ARG DEBIAN_FRONTEND=noninteractive

# ---- System deps (keep minimal) ----
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates git build-essential \
    libcurl4-openssl-dev libssl-dev libxml2-dev \
    libhdf5-dev \
    libzmq3-dev \
    libgsl-dev libmagick++-dev \
    && rm -rf /var/lib/apt/lists/*

# ---- micromamba (Python env) ----
ENV MAMBA_ROOT_PREFIX=/opt/conda
RUN curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest \
  | tar -xvj bin/micromamba \
  && mv bin/micromamba /usr/local/bin/mic [+]

# Create Python env (align with Colab-ish modern stack)
RUN micromamba create -y -n py -c conda-forge \
    python=3.12 pip \
    jupyterlab ipykernel \
    numpy pandas scipy \
    scanpy python-igraph leidenalg \
    matplotlib \
  && micromamba clean -a -y

ENV PATH=/opt/conda/envs/py/bin:$PATH

# Register Python kernel
RUN python -m ipykernel install --sys-prefix \
    --name python3 --display-name "Python (llm-scCurator)"

# ---- R packages (lite: only what we truly need) ----
# CRAN
RUN install2.r --error --deps TRUE \
    remotes tidyverse reshape2 ggplot2 zip patchwork hdf5r

# Bioconductor (pin to 3.22 for R 4.5)
RUN R -q -e 'install.packages("BiocManager", repos="https://cloud.r-project.org"); \
    BiocManager::install(version="3.22", ask=FALSE); \
    BiocManager::install(c("SingleR","celldex","SingleCellExperiment","zellkonverter",\
                           "scran","scater","scuttle","DropletUtils"), \
                         ask=FALSE, update=FALSE)'

# Seurat (heavy-ish but requested)
RUN install2.r --error --deps TRUE Seurat

# IRkernel (R kernel for Jupyter) :contentReference[oaicite:3]{index=3}
RUN install2.r --error --deps TRUE IRkernel \
  && R -q -e 'IRkernel::installspec(user = FALSE)'

# ---- Install your package ----
WORKDIR /opt/LLM-scCurator
COPY . /opt/LLM-scCurator
RUN pip install -e ".[all]"

# Jupyter
WORKDIR /work
EXPOSE 8888
CMD ["bash","-lc","jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''"]
